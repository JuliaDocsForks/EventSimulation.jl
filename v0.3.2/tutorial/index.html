<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Bogumił Kamiński">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Tutorial - EventSimulation.jl</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../assets/Documenter.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Tutorial";
    var mkdocs_page_input_path = "tutorial.md";
    var mkdocs_page_url = "/tutorial/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> EventSimulation.jl</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Tutorial</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#eventsimulation-tutorial">EventSimulation Tutorial</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#installation">Installation</a></li>
        
            <li><a class="toctree-l3" href="#first-simulation">First simulation</a></li>
        
            <li><a class="toctree-l3" href="#defining-infinite-source-of-events">Defining infinite source of events</a></li>
        
            <li><a class="toctree-l3" href="#defining-custom-simulation-state">Defining custom simulation state</a></li>
        
            <li><a class="toctree-l3" href="#monitoring-simulation">Monitoring simulation</a></li>
        
            <li><a class="toctree-l3" href="#introduction-to-resources">Introduction to resources</a></li>
        
            <li><a class="toctree-l3" href="#infinite-delta-in-repeat_register">Infinite delta in repeat_register!</a></li>
        
            <li><a class="toctree-l3" href="#bulk-execution-of-events">Bulk execution of events</a></li>
        
            <li><a class="toctree-l3" href="#next-steps">Next steps</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../reference/">Reference</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">EventSimulation.jl</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Tutorial</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/bkamins/EventSimulation.jl/edit/master/docs/tutorial.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><a id='tutorial-1'></a></p>
<h1 id="eventsimulation-tutorial">EventSimulation Tutorial</h1>
<p><a id='Installation-1'></a></p>
<h2 id="installation">Installation</h2>
<p>In REPL run <code>Pkg.add("EventSimulation")</code> to install the package and next <code>using EventSimulation</code> to start using it.</p>
<p><a id='First-simulation-1'></a></p>
<h2 id="first-simulation">First simulation</h2>
<p>This is a bare minimum simulation using EventSimulation:</p>
<pre><code>using EventSimulation

function arrival(s)
    t = s.now
    println(&quot;Arrived at &quot;, s.now)
    register!(s, x -&gt; println(&quot;Left at $(x.now) that arrived at $t&quot;), 1.5)
end

s = Scheduler()
for t in 1.0:5.0
    register!(s, arrival, t)
end

go!(s)
</code></pre>

<p>In this example five customers arrive at times 1, 2, ..., 5 and stay in the system for 1.5 time units. Observe that in <code>arrival</code> we use a closure to define anonymous function that is registered. In its body <code>x.now</code> will be taken from the state of the scheduler when the anonymous function is invoked but <code>t</code> is fixed in enclosing scope of <code>arrival</code> function as the time of the arrival.</p>
<p><strong>Exercise</strong>: <em>Test what happens if you replace <code>$t</code> with <code>$(s.now)</code> in the anonymous function. What is the reason of this behavior?</em></p>
<p>When using EventSimulation working with closures is often the simplest way to develop a simulation so it is important that you understand this example.</p>
<p><a id='Defining-infinite-source-of-events-1'></a></p>
<h2 id="defining-infinite-source-of-events">Defining infinite source of events</h2>
<p>Now we add an infinite stream of customers arriving to the system:</p>
<pre><code>using EventSimulation

function arrival(s)
    t = s.now
    println(&quot;Arrived at &quot;, s.now)
    register!(s, x -&gt; println(&quot;Left at $(x.now) that arrived at $t&quot;), 1.5)
end

s = Scheduler()
repeat_register!(s, arrival, x -&gt; 1.0)

go!(s, 7)

</code></pre>

<p>In this example we show how <code>arrival</code> function can be scheduled to be repeatedly put into event queue in time deltas defined by anonymous function <code>x -&gt; 1.0</code>.</p>
<p>Aslo observe that we have passed second argument <code>7</code> to function <code>go!</code> which will force unconditional termination of the simulation after this moment.</p>
<p><strong>Exercise</strong>: <em>Think what would happen if the termination time would be omitted in the expression <code>go!(s, 7)</code>. How you could use function <code>terminate!</code> inside definition of <code>arrival</code> to get a similar effect. What would be the difference?</em></p>
<p><a id='Defining-custom-simulation-state-1'></a></p>
<h2 id="defining-custom-simulation-state">Defining custom simulation state</h2>
<p>Now let us add a simple counter of number of customers in the system:</p>
<pre><code>using EventSimulation

mutable struct CounterState &lt;: AbstractState
    count::Int
end

function arrival(s)
    function departure(x)
        x.state.count -= 1
        println(&quot;Left at $(x.now) that arrived at $t and left &quot;,
                x.state.count, &quot; other customers&quot;)
    end

    t = s.now
    println(&quot;Arrived at &quot;, s.now, &quot; and met &quot;, s.state.count, &quot; other customers&quot;)
    register!(s, departure, 1.0)
    s.state.count += 1
end

s = Scheduler(CounterState(0))

srand(1)
repeat_register!(s, arrival, x -&gt; rand())
go!(s, 10)
</code></pre>

<p>Observe that all functions in EventSimulation receive <code>Scheduler</code> as an argument and therefore they have acces to current simulation time and simulation state.</p>
<p>Additionally we have changed customer arrival behavior to random.</p>
<p><strong>Exercise</strong>: <em>Try changing customer's arrival rate to the exponential distribution using <code>randexp</code> function. Next change time in system distribution to the Gamma distribution. You can find it in <code>Distributions</code> package.</em></p>
<p><a id='Monitoring-simulation-1'></a></p>
<h2 id="monitoring-simulation">Monitoring simulation</h2>
<p>Let us calculate how many customers are present in the above system using custom <code>monitor</code>.</p>
<pre><code>using EventSimulation

mutable struct CounterState &lt;: AbstractState
    count::Int
    total_time::Float64
    customer_time::Float64
end

function arrival(s)
    register!(s, departure, 1.0)
    s.state.count += 1
end

function departure(s)
    s.state.count -= 1
end

function monitor(s, Δ)
    s.state.total_time += Δ
    s.state.customer_time += Δ * s.state.count
end

cs = CounterState(0, 0.0, 0.0)
s = Scheduler(cs, Float64, monitor)

srand(1)
repeat_register!(s, arrival, x -&gt; rand())
go!(s, 100_000)
println(&quot;Average number of customers in a system is &quot;,
        cs.customer_time/cs.total_time)
</code></pre>

<p>Observe that <code>monitor</code> usually will modify simulation state to gather the simulation statistics. Other approaches could use global variables or variables defined in closure of <code>monitor</code>, but using simulation state is the recommended approach.</p>
<p><strong>Exercise</strong>: <em>Think if the obtained result is in line with <a href="https://en.wikipedia.org/wiki/Little%27s_law">Little's law</a>. Try changing arrival rate and time in the system to check it. As a more advanced exercise make <code>monitor</code> collect data only when simulation time is greater or equal than 100 (i.e. discarding simulation burn-in period).</em></p>
<p><a id='Introduction-to-resources-1'></a></p>
<h2 id="introduction-to-resources">Introduction to resources</h2>
<p>Now we will consider two streams of agents. Supplier provides one unit of good every one unit of time. There are customers that arrive randomly and want to buy a random amount of good. Maximally two customers can wait in the line.</p>
<pre><code>using EventSimulation

mutable struct GoodState &lt;: AbstractState
    good::SimResource{Float64}
end

function delivery(s)
    provide!(s, s.state.good, 1.0)
    print_with_color(:green, &quot;Delivered 1.0 at &quot;, s.now, &quot;\n&quot;)
end

function customer(s)
    function leave(x)
        println(&quot;Left at &quot;, x.now, &quot; with quantity &quot;, round(demand, 4))
    end
    demand = rand()
    print(&quot;Arrived at &quot;, round(s.now, 4), &quot; with demand &quot;, round(demand, 4))
    if !request!(s, s.state.good, demand, leave)[1]
        print_with_color(:red, &quot; but line was too long and left with nothing\n&quot;)
    else
        println(&quot; and went into a queue&quot;)
    end
end

function balance(s)
    info(&quot;Amount of good in storage: &quot;,
         round(s.state.good.quantity, 4), &quot; at time &quot;, s.now)
end

s = Scheduler(GoodState(SimResource{Float64}(max_requests=2)))

srand(1)
repeat_register!(s, delivery, x -&gt; 1.0)
repeat_register!(s, customer, x -&gt; rand())
repeat_register!(s, balance, x -&gt; x.now == 0 ? 1.000001 : 1.0)
go!(s, 5)
</code></pre>

<p>Observe that fulfillment of pending requests by <code>SimResource</code> is immediate. This means that the amount is passed to a request from the container before the request event executed.</p>
<p><strong>Exercise</strong>: <em>We have used a fixed value of <code>0.000001</code> as an increment over an integer number to invoke <code>balance</code>. Rewrite the example using <code>PriorityTime</code> type in such a way that <code>balance</code> is invoked at integer times but with priority low enough.</em></p>
<p><a id='Infinite-delta-in-repeat_register!-1'></a></p>
<h2 id="infinite-delta-in-repeat_register">Infinite delta in <code>repeat_register!</code></h2>
<p>In general EventSimulation does not check the values passed to the engine in order to maximize execution speed. The only exception is <code>interval</code> argument of <code>repeat_register</code> function. If it returns a value that is not finite then the repeated scheduling of events is interrupted. Here is a simple example</p>
<pre><code>using EventSimulation

mutable struct Jumps &lt;: AbstractState
    n::Int
end

jump(s) = s.state.n+=1
next(s) = s.now &gt;= 1.0 ? NaN : rand()

function main()
    s = Scheduler(Jumps(0))
    repeat_register!(s, jump, next)
    go!(s)
    s.state.n
end

println(mean(main() for i in 1:10^6))
</code></pre>

<p>The above code implements a well known puzzle. Assume that we have a bug that gets hungry every <code>rand()</code> time units and eats then. Assume that the fist time it eats is 0. What is the expected number of times it will it till time reaches 1.0? Run the code to learn the answer (if you did not know the puzzle before). Observe that returning <code>NaN</code> from <code>next</code> forces the simulation to stop.</p>
<p><a id='Bulk-execution-of-events-1'></a></p>
<h2 id="bulk-execution-of-events">Bulk execution of events</h2>
<p>EventSimulation allows you to plan execution of a batch of actions at the same time. They can be either executed in a predefined order or in random order (this example actually does not require DES, but is a MWE of <code>bulk_register!</code>).</p>
<pre><code>using EventSimulation

mutable struct Airplane &lt;: AbstractState
    free::Set{Int}
    ok::Bool
end

function sit(s, i)
    s.state.ok = i in s.state.free
    pop!(s.state.free, s.state.ok ? i : rand(s.state.free))
end

function main(n)
    s = Scheduler(Airplane(Set(1:n), false))
    tickets = randperm(n)
    tickets[1] = rand(1:n)
    bulk_register!(s, tickets, sit, 0.0)
    go!(s)
    s.state.ok
end

for n in [10, 50, 250]
    println(n, &quot;\t&quot;, mean(main(n) for i in 1:10^4))
end
</code></pre>

<p>Another simple puzzle. We have an airplane with <code>n</code> seats and <code>n</code> customers. Every customer has a ticket with seat number. It is represented by a vector <code>tickets</code>. Customers enter the airplane in the order of the vector <code>tickets</code> and everyone tries to sit on her own seat. Unfortunately <code>tickets[1] = rand(1:n)</code> so the firs customer has forgotten her seat number and have chosen a random seat. When the following customers enter the airplane and find their seat taken they pick a random free seat. The question is what is the probability that last customer that enters the plane finds her seat taken as a function of <code>n</code>. Run the simulation to find out if you do not know the answer!</p>
<p><a id='Next-steps-1'></a></p>
<h2 id="next-steps">Next steps</h2>
<p>This is the end of this introductory tutorial. More advanced features are covered in examples contained in <code>/examples/</code> directory.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../reference/" class="btn btn-neutral float-right" title="Reference">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/bkamins/EventSimulation.jl" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../reference/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../js/theme.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../assets/mathjaxhelper.js"></script>

</body>
</html>
